<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../ac-view/ac-led-group.html">
<link rel="import" href="../paper-range-slider/paper-range-slider.html">
<link rel="import" href="../local-dom/local-dom.html">
<link rel="import" href="../ac-view/view-audio.html">
<link rel="import" href="./piano-semi-key.html">
<link rel="import" href="./piano-key.html">


<dom-module id="piano-keys">
    <template>
        <style>
            [wrapper] {
                height: 90%;
                width: 100%;
                @apply --layout-center;
                @apply --layout-vertical;
                @apply --layout-center-justified;
            }

            [piano] {
                @apply --layout-center-justified;
                @apply --layout-horizontal;
            }

            [piano]:active {
                cursor: move;
            }

            [desktop] [piano] {
                margin-top: 80px;
            }

            .noDisplay {
                display: none;
            }

            .vertical {
                transform: rotate(90deg);
            }

            .horizontal {
                transform: rotate(0deg);
            }

            [range] {
                height: 10%;
                width: 100%;
                @apply --layout-center;
                @apply --layout-vertical;
                @apply --layout-center-justified;
            }

            paper-range-slider {
                will-change: transform;
                cursor: pointer;
                --paper-range-slider-active-color: var(--ac-led-shadow, gray);
                --paper-range-slider-knob-color: var(--ac-led-shadow, gray);
                --paper-range-slider-pin-color: var(--ac-led-shadow, gray);
                --paper-range-slider-pin-start-color: var(--ac-led-shadow, gray);
            }
        </style>
        <view-audio id="pianoAudio" channel='0' default-audio-url='/data/accordion_synth/treble.mp3'></view-audio>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" desktop="{{desktop}}">
            <div wrapper class$="{{_computeRotation(___acV_rotation,mobile)}}">
                <div piano on-track='_handleTrack'>
                    <piano-key class$='[[keyDisplays.0]]' acLed ac-id='24' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.1]]' position='left' acLed ac-id='25' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.2]]' acLed ac-id='26' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.3]]' position='right' acLed ac-id='27' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.4]]' acLed ac-id='28' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.5]]' acLed ac-id='29' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.6]]' position='left' acLed ac-id='30' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.7]]' acLed ac-id='31' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.8]]' position='center' acLed ac-id='32' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.9]]' acLed ac-id='33' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.10]]' position='right' acLed ac-id='34' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.11]]' acLed ac-id='35' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.12]]' acLed ac-id='36' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.13]]' position='left' acLed ac-id='37' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.14]]' acLed ac-id='38' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.15]]' position='right' acLed ac-id='39' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.16]]' acLed ac-id='40' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.17]]' acLed ac-id='41' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.18]]' position='left' acLed ac-id='42' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.19]]' acLed ac-id='43' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.20]]' position='center' acLed ac-id='44' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.21]]' acLed ac-id='45' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.22]]' position='right' acLed ac-id='46' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.23]]' acLed ac-id='47' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.24]]' acLed ac-id='48' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.25]]' position='left' acLed ac-id='49' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.26]]' acLed ac-id='50' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.27]]' position='right' acLed ac-id='51' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.28]]' acLed ac-id='52' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.29]]' acLed ac-id='53' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.30]]' position='left' acLed ac-id='54' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.31]]' acLed ac-id='55' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.32]]' position='center' acLed ac-id='56' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.33]]' acLed ac-id='57' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.34]]' position='right' acLed ac-id='58' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.35]]' acLed ac-id='59' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.36]]' acLed ac-id='60' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.37]]' position='left' acLed ac-id='61' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.38]]' acLed ac-id='62' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.39]]' position='right' acLed ac-id='63' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.40]]' acLed ac-id='64' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.41]]' acLed ac-id='65' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.42]]' position='left' acLed ac-id='66' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.43]]' acLed ac-id='67' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.44]]' position='center' acLed ac-id='68' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.45]]' acLed ac-id='69' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.46]]' position='right' acLed ac-id='70' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.47]]' acLed ac-id='71' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.48]]' acLed ac-id='72' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.49]]' position='left' acLed ac-id='73' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.50]]' acLed ac-id='74' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.51]]' position='right' acLed ac-id='75' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.52]]' acLed ac-id='76' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.53]]' acLed ac-id='77' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.54]]' position='left' acLed ac-id='78' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.55]]' acLed ac-id='79' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.56]]' position='center' acLed ac-id='80' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.57]]' acLed ac-id='81' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.58]]' position='right' acLed ac-id='82' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.59]]' acLed ac-id='83' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.60]]' acLed ac-id='84' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.61]]' position='left' acLed ac-id='85' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.62]]' acLed ac-id='86' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.63]]' position='right' acLed ac-id='87' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.64]]' acLed ac-id='88' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.65]]' acLed ac-id='89' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.66]]' position='left' acLed ac-id='90' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.67]]' acLed ac-id='91' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.68]]' position='center' acLed ac-id='92' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.69]]' acLed ac-id='93' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.70]]' position='right' acLed ac-id='94' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.71]]' acLed ac-id='95' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.72]]' acLed ac-id='96' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.73]]' position='left' acLed ac-id='97' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.74]]' acLed ac-id='98' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.75]]' position='right' acLed ac-id='99' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.76]]' acLed ac-id='100' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.77]]' acLed ac-id='101' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.78]]' position='left' acLed ac-id='102' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.79]]' acLed ac-id='103' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.80]]' position='center' acLed ac-id='104' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.81]]' acLed ac-id='105' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.82]]' position='right' acLed ac-id='106' channel='0'></piano-semi-key>
                    <piano-key class$='[[keyDisplays.83]]' acLed ac-id='107' channel='0'></piano-key>
                    <piano-key class$='[[keyDisplays.84]]' acLed ac-id='108' channel='0'></piano-key>
                    <piano-semi-key class$='[[keyDisplays.85]]' position='left' acLed ac-id='109' channel='0'></piano-semi-key>
                </div>
            </div>
            <div range>
                <paper-range-slider id='rangeSlider' value-diff-min='5' min='0' max='100' value-max="{{rangeHigh}}" value-min="{{rangeLow}}"
                    on-change='_onRangeChange' on-value-change='_onRangeChange'>
                </paper-range-slider>
            </div>
        </local-dom>
    </template>
    <script>
        class PianoKeys extends ACLedGroup {
            static get is() { return 'piano-keys'; }
            static get properties() {return {
                keyDisplays: {type: Array,value: []},
                rangeHigh: {type: Number,value: 100},
                rangeLow: {type: Number,value: 0},
                scrolling: {type: Boolean,value: false}
            }}
            constructor() {
                super();
            }
            async _wheelZoom (e) {
                e.stopPropagation();
                e.preventDefault();

                if (this.scrolling)
                    return;
                this.scrolling = true;
                var scroll = e.wheelDelta;
                if (scroll < 0) {
                    if (this.rangeLow > 0) {
                        this.rangeLow--;
                    }
                    if (this.rangeHigh < 100) {
                        this.rangeHigh++;
                    }
                }
                if (scroll > 0) {
                    if (this.rangeHigh - this.rangeLow > 6) {
                        this.rangeLow++;
                        this.rangeHigh--;
                    }
                }
                await sleep(50);
                this.scrolling = false;
            }
            _setNoteNames () {
                var nodeList = Polymer.dom(this.root).querySelectorAll('PIANO-KEY');
                for (let i = 0; i < nodeList.length; i++) {
                    var note = nodeList[i].acId;
                    nodeList[i].note = "C C#D EbE F F#G AbA BbB ";
                    nodeList[i].note = (nodeList[i].note.substring((note % 12) * 2, (note % 12) * 2 + 2) + (Math.floor(note / 12)).toString()).replace(" ", "");
                }
                nodeList = Polymer.dom(this.root).querySelectorAll('PIANO-SEMI-KEY');
                for (let i = 0; i < nodeList.length; i++) {
                    var note = nodeList[i].acId;
                    nodeList[i].note = "C C#D EbE F F#G AbA BbB ";
                    nodeList[i].note = (nodeList[i].note.substring((note % 12) * 2, (note % 12) * 2 + 2) + (Math.floor(note / 12)).toString()).replace(" ", "");
                }
            }
            async _handleTrack (e) {
                e.preventDefault();
                e.stopPropagation();
                if (this.scrolling)
                    return;
                this.scrolling = true;
                var scroll = e.detail.ddx
                if (this.___acV_rotation) {
                    scroll = e.detail.ddy;
                }
                if (scroll < 0) {
                    if (this.rangeLow < 95) {
                        this.rangeLow++;
                    }
                    if (this.rangeHigh < 100) {
                        this.rangeHigh++;
                    }
                }
                if (scroll > 0) {
                    if (this.rangeLow > 1) {
                        this.rangeLow--;
                    }
                    if (this.rangeHigh > 5) {
                        this.rangeHigh--;
                    }
                }
                await sleep(50);
                this.scrolling = false;
            }
            ___acV_midiEventToAudioNote (channel, midiNote, origin) {
                if (origin.startsWith('___midi_instrument'))
                    return midiNote;
                return this.___acV_midiEventToAudioNoteDefault(channel, midiNote, origin);
            }
            ___acV_mapMIDIEventToAcLedId (channel, midiNote, origin) {
                if (!origin.startsWith('___midi_instrument')) {
                    return [midiNote + this.___acV_referencePitch - this.___acV_pitch];
                }
                return [midiNote];
            }
            _computeRotation (rotation, mobile) {
                if (rotation || mobile)
                    return "vertical";
                return "horizontal";
            }
            _onRangeChange (e) {
                var numKeys = Polymer.dom(this.root).querySelectorAll("[acLed]").length;
                var low = Math.floor((this.rangeLow / 100) * numKeys);
                var high = Math.floor((this.rangeHigh / 100) * numKeys);
                this.keyDisplays = [];
                for (let i = 0; i < low; i++) {
                    this.keyDisplays[i] = 'noDisplay';
                }
                for (let i = high + 1; i < numKeys; i++) {
                    this.keyDisplays[i] = 'noDisplay';
                }
                this._updateDisplayArray();
            }
            _updateDisplayArray () {
                var arr = this.keyDisplays;
                this.keyDisplays = [];
                this.keyDisplays = arr;
            }
            ready() {
                super.ready() ;
                var tot = window.innerWidth
                tot *= 0.7;
                if (this.mobile) {
                    tot = window.innerHeight;
                    tot *= 0.8;
                }
                var visibleKeys = Math.floor(tot / 36);
                visibleKeys += 5 * Math.floor(visibleKeys / 7);
                var numKeys = Polymer.dom(this.root).querySelectorAll("[acLed]").length;
                visibleKeys = Math.min(numKeys, visibleKeys);
                var per = visibleKeys / numKeys;
                this.rangeLow = Math.floor((1 - per) / 2 * 100);
                this.rangeHigh = Math.ceil(((1 - per) / 2 + per) * 100);
                this._onRangeChange();

                var startNote = 55 ; 
                for(let i = startNote ; i < startNote+12 ; i ++ ){
                    this.___acV_setChord(i, 'M', [
                        [0, i , i+4, i+7]
                    ]);
                }
                for(let i = startNote ; i < startNote+12 ; i ++ ){
                    this.___acV_setChord(i, 'm', [
                        [0, i , i+3, i+7]
                    ]);
                }
                this._setNoteNames();
                Polymer.RenderStatus.afterNextRender(this, function() {
                    this.addEventListener('wheel', e => this._wheelZoom(e));
                });
            }
        }
        customElements.define('piano-keys', PianoKeys);
    </script>
</dom-module>